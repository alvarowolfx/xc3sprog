# Project
cmake_minimum_required (VERSION 2.8.4 FATAL_ERROR)

project(xc3sprog CXX)
if (CMAKE_VERSION VERSION_LESS 100)
  # C language still needed because the following required CMake modules
  # (or their dependencies, respectively) are not correctly handling
  # the case where only CXX is enabled.
  # - CheckTypeSize.cmake (fixed in CMake 3.1, cf. http://www.cmake.org/Bug/view.php?id=14056)
  # - FindThreads.cmake (--> CheckIncludeFiles.cmake <--)
  enable_language (C)
endif ()

# Add FindAndroidThings.cmake dir to the module path.
set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} ${CMAKE_SOURCE_DIR}/../libandroidthings)
set(ANDROIDTHINGS_LIBRARY ${CMAKE_SOURCE_DIR}/../libandroidthings/armeabi-v7a/lib/libandroidthings.so)
set(ANDROIDTHINGS_INCLUDE_DIR ${CMAKE_SOURCE_DIR}/../libandroidthings/armeabi-v7a/include)
# Resolve Android Things headers and libraries
find_package(AndroidThings REQUIRED)
include_directories(${ANDROIDTHINGS_INCLUDE_DIR})

include_directories(${CMAKE_SOURCE_DIR})

ADD_CUSTOM_COMMAND(OUTPUT devices.h
    COMMAND ${CMAKE_COMMAND} -DDEVLIST_DIR=${CMAKE_SOURCE_DIR} -P ${CMAKE_SOURCE_DIR}/devlist.cmk
    DEPENDS devlist.txt
)

ADD_CUSTOM_COMMAND(OUTPUT cables.h
    COMMAND ${CMAKE_COMMAND} -DCABLELIST_DIR=${CMAKE_SOURCE_DIR} -P ${CMAKE_SOURCE_DIR}/cablelist.cmk
    DEPENDS cablelist.txt
)

INCLUDE_DIRECTORIES(BEFORE ${CMAKE_CURRENT_BINARY_DIR})

add_library(xc3sproglib  STATIC sysfs.cpp  
                        devicedb.cpp jtag.cpp jedecfile.cpp bitfile.cpp 
			iobase.cpp  utilities.cpp
			progalgxc3s.cpp progalgxcfp.cpp
			progalgxcf.cpp
			bitrev.cpp
                        cabledb.cpp 
                        ${CONDITIONAL_FILES} devices.h cables.h)

add_executable(xc3sprog xc3sprog.cpp srecfile.cpp devices.h)

target_link_libraries(xc3sprog xc3sproglib ${CONDITIONAL_LIBS}  ${LIBS} ${ANDROIDTHINGS_LIBRARIES})
set_property(TARGET xc3sprog PROPERTY CXX_STANDARD 11)
install(TARGETS xc3sprog DESTINATION bin)

SET_DIRECTORY_PROPERTIES(PROPERTIES ADDITIONAL_MAKE_CLEAN_FILES "${GENERATED_FILES}") 
